<?xml version="1.0" encoding="UTF-8"?>
<!--+
    |
    | Copyright (c) 2012, ROE (http://www.roe.ac.uk/)
    | All rights reserved.
    |
    | This program is free software: you can redistribute it and/or modify
    | it under the terms of the GNU General Public License as published by
    | the Free Software Foundation, either version 3 of the License, or
    | (at your option) any later version.
    |
    | This program is distributed in the hope that it will be useful,
    | but WITHOUT ANY WARRANTY; without even the implied warranty of
    | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    | GNU General Public License for more details.
    |
    | You should have received a copy of the GNU General Public License
    | along with this program.  If not, see <http://www.gnu.org/licenses/>.
    |
    +-->
<beans
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:txn="http://www.springframework.org/schema/tx"
    xmlns:cxt="http://www.springframework.org/schema/context"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd

        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd

        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        "
    >

    <!--+
        | Create our HibernateSessionFactory from the JPA annotations, @Entity, @Table, @Column, @Id etc.
        +-->
    <bean id="FireThornHibernateSessionFactory" class="org.springframework.orm.hibernate3.annotation.AnnotationSessionFactoryBean">

        <property name="dataSource" ref="FireThornDatabase"/>

        <!--+
            | List the JPA annotated classes.
            +-->
        <property name="annotatedClasses">
            <list>
                <!--+
                    |
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.core.TagEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.core.JobEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.core.AccountEntity</value>

                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.TapTableEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.TapColumnEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.TapServiceEntity</value>

                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.normal.TapRowEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.normal.TapJoinEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.normal.RowTagEntity</value>
                <value>org.jiscinvolve.astrodabis.barberry.hibernate.data.normal.JoinTagEntity</value>
                    |
                    +-->
            </list>
        </property>

        <!--+
            | Replace the Hibernate config with bean properties.
            | http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html
            +-->
        <property name="hibernateProperties">
            <props>
                <!--+
                    | "In most cases Hibernate will be able to choose the correct org.hibernate.dialect.Dialect
                    | implementation based on the JDBC metadata returned by the JDBC driver."
                <prop key="hibernate.dialect">org.hibernate.dialect.PostgreSQLDialect</prop>
                    +-->
                <!--+
                    | Automatically update the database tables (test only).
                    +-->
                <prop key="hibernate.hbm2ddl.auto">update</prop>
                <prop key="hibernate.show_sql">false</prop>

            </props>
        </property>

    </bean>

    <!--+
        | Create our HibernateTransactionManager instance.
        +-->
    <bean id="FireThornTransactionManager" class="org.springframework.orm.hibernate3.HibernateTransactionManager">
        <property name="sessionFactory" ref="FireThornHibernateSessionFactory"/>
    </bean>

    <!--+
        | Provide support for the @Transactional annotation.
        | The transaction-manager attribute is optional, if the TransactionManager bean is called 'transactionManager'.
        | The proxy-target-class setting is needed to solve apparent clash between @Autowired and @Transactional
        | http://forum.springsource.org/showthread.php?57995-Strange-clash-Transactional-Autowired
        | http://forum.springsource.org/showthread.php?87796-Issue-Injecting-Transactional-DAO-Object-into-Unit-Test
        +-->
    <txn:annotation-driven
        transaction-manager="FireThornTransactionManager"
         proxy-target-class="true"
         />

    <!--+
        | Create a HibernateTemplate to wrap our HibernateSessionFactory.
        +-->
    <bean id="FireThornHibernateTemplate" class="org.springframework.orm.hibernate3.HibernateTemplate">
        <property name="sessionFactory" ref="FireThornHibernateSessionFactory"/>
    </bean>

</beans>
