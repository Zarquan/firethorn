<?xml version="1.0" encoding="UTF-8"?>
<!--+
    |
    |  Copyright (c) 2011, AstroDAbis
    |  All rights reserved.
    |
    |  Redistribution and use in source and binary forms, with or without modification,
    |  are permitted provided that the following conditions are met:
    |
    |      * Redistributions of source code must retain the above copyright notice,
    |        this list of conditions and the following disclaimer.
    |      * Redistributions in binary form must reproduce the above copyright notice,
    |        this list of conditions and the following disclaimer in the documentation
    |        and/or other materials provided with the distribution.
    |
    |  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
    |  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
    |  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
    |  IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
    |  INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
    |  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    |  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
    |  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
    |  OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
    |  OF THE POSSIBILITY OF SUCH DAMAGE.
    |
    +-->
<beans
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:txn="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd

        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
        "
    >

    <!--+
        | Hibernate SessionFactory.
        +-->
    <bean id="FireThornHibernateSessionFactory" class="org.springframework.orm.hibernate4.LocalSessionFactoryBean">

        <!--+
            | Database connection.
            +-->
        <property name="dataSource" ref="FireThornMetaData"/>

        <!--+
            | List our annotated entity beans.
            +-->
        <property name="annotatedClasses">
            <list>

                <value>uk.ac.roe.wfau.firethorn.job.test.TestJobEntity</value>

                <value>uk.ac.roe.wfau.firethorn.config.ConfigPropertyEntity</value>

                <value>uk.ac.roe.wfau.firethorn.identity.IdentityEntity</value>

                <value>uk.ac.roe.wfau.firethorn.meta.adql.AdqlResourceEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.adql.AdqlSchemaEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.adql.AdqlTableEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.adql.AdqlColumnEntity</value>
                <value>uk.ac.roe.wfau.firethorn.adql.query.AdqlQueryEntity</value>

                <value>uk.ac.roe.wfau.firethorn.meta.ivoa.IvoaResourceEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.ivoa.IvoaSchemaEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.ivoa.IvoaTableEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.ivoa.IvoaColumnEntity</value>

                <value>uk.ac.roe.wfau.firethorn.meta.base.BaseResourceEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.base.BaseSchemaEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.base.BaseTableEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.base.BaseColumnEntity</value>

                <value>uk.ac.roe.wfau.firethorn.meta.jdbc.JdbcResourceEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.jdbc.JdbcSchemaEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.jdbc.JdbcTableEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.jdbc.JdbcColumnEntity</value>
                <value>uk.ac.roe.wfau.firethorn.meta.jdbc.JdbcConnectionEntity</value>

            </list>
        </property>

        <!--+
            | Set the component naming strategy.
            | https://forum.hibernate.org/viewtopic.php?p=2404537
        <property name="namingStrategy">
            <bean class="org.hibernate.cfg.DefaultComponentSafeNamingStrategy" />
        </property>
            +-->

        <!--+
            | Replace the Hibernate config with bean properties.
            | http://docs.jboss.org/hibernate/core/3.3/reference/en/html/session-configuration.html
            +-->
        <property name="hibernateProperties">
            <props>

                <!--+
                    | Automatically update the database tables (test only).
                    +-->
                <prop key="hibernate.hbm2ddl.auto">update</prop>
                <prop key="hibernate.show_sql">false</prop>

                <!--+
                    | Add a prefix to embedded components.
                    | http://stackoverflow.com/questions/3046677/automatically-add-a-prefix-to-column-names-for-embeddable-classes
                    +-->
                <prop key="hibernate.ejb.naming_strategy">org.hibernate.cfg.DefaultComponentSafeNamingStrategy</prop>

                <!--+
                    | Jadira usertype registration.
                    | http://usertype.sourceforge.net/
                    +-->
                <prop key="jadira.usertype.autoRegisterUserTypes">true</prop>

                <!--+
                    | c3p0 connection pool.
                    | https://docs.jboss.org/hibernate/orm/4.0/devguide/en-US/html/ch01.html#d0e318

https://community.jboss.org/wiki/HowToConfigureTheC3P0ConnectionPool
http://www.mkyong.com/hibernate/how-to-configure-the-c3p0-connection-pool-in-hibernate/
https://community.jboss.org/wiki/HowToConfigureTheC3P0ConnectionPool
http://stackoverflow.com/questions/475893/what-are-the-required-c3p0-settings-for-hibernate-in-order-to-avoid-deadlocks

                <prop key="c3p0.min_size">5</prop>
                <prop key="c3p0.max_size">10</prop>

                <prop key="hibernate.c3p0.min_size">5</prop>
                <prop key="hibernate.c3p0.max_size">10</prop>
                <prop key="hibernate.c3p0.timeout"></prop>
                <prop key="hibernate.c3p0.max_statements"></prop>

                    +-->

                <!--+
                    | Optional properties.
                    | https://docs.jboss.org/hibernate/orm/3.3/reference/en/html/session-configuration.html#configuration-optional
                    | hibernate.default_schema 
                    | hibernate.default_catalog  
                    +-->

            </props>
        </property>

    </bean>

    <!--+
        | Create our SessionFactoryUtils instance.
    <bean id="FireThornSessionFactoryUtils" class="org.springframework.orm.hibernate4.SessionFactoryUtils">
    </bean>
        +-->

    <!--+
        | Create our HibernateTransactionManager instance.
        +-->
    <bean id="FireThornTransactionManager" class="org.springframework.orm.hibernate4.HibernateTransactionManager">
        <property name="sessionFactory" ref="FireThornHibernateSessionFactory"/>
    </bean>

    <!--+
        | Provide support for the @Transactional annotation.
        | The transaction-manager attribute is optional if the TransactionManager bean is called 'transactionManager'.
        | The proxy-target-class setting is needed to solve apparent clash between @Autowired and @Transactional
        | http://forum.springsource.org/showthread.php?57995-Strange-clash-Transactional-Autowired
        +-->
    <txn:annotation-driven
        transaction-manager="FireThornTransactionManager"
         proxy-target-class="true"
         />

</beans>
