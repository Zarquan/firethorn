#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2014, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#  
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

apt-get install mercurial
apt-get install maven
apt-get install g++
apt-get install unixodbc unixodbc-dev freetds-dev tdsodbc python-dev libmyodbc
apt-get install mysql-server mysql-client

## edit odbc.ini  and odbcinst.ini files (/etc/)

wget https://pyodbc.googlecode.com/files/pyodbc-3.0.7.zip
unzip pyodbc-3.0.7.zip
cd pyodbc-3.0.7/
python setup.py install

## setup ssh keys


ssh -v -L '*:1435:ramses5:1433' -L '*:1436:ramses6:1433' -L '*:1439:ramses9:1433' "${sshusername}@${sshhostname:?}"

## new terminal
cd ~
hg clone ssh://${sshuser}@${sshhost}:${sshport}/${sshpath} hg
cd hg
hg update -C 1.10.8-stv-pyrothorn
mvn -P all clean install
mvn -P all eclipse:eclipse

## create firethorn.properties

# create mysql reporting database
mysql -u${mysqlusername}
    CREATE DATABASE pyrothorn_testing;
    USE pyrothorn_testing;
    CREATE TABLE IF NOT EXISTS `queries` (
       `queryid` int(10) unsigned NOT NULL AUTO_INCREMENT,
       `query` text NOT NULL,
       `direct_sql_rows` int(11) NOT NULL,
       `firethorn_sql_rows` int(11) NOT NULL,
       `firethorn_duration` varchar(60) NOT NULL,
       `sql_duration` varchar(60) NOT NULL,
       `test_passed` tinyint(1) NOT NULL,
       `firethorn_version` varchar(60) NOT NULL,
       `error_message` varchar(60) NOT NULL,
       PRIMARY KEY (`queryid`)
     ) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=10 ;



cd ~/hg
pushd 'firethorn-webapp'

        export MAVEN_OPTS=-Xmx128m
        mvn tomcat7:run | tee /tmp/firethorn-tomcat.log

    popd


## new terminal
cd ~/hg
 pushd 'firethorn-ogsadai/webapp'


            mvn clean compile war:war

            source src/test/bin/jdbc-functions.sh

            projversion=$(
                sed -n "
                    s/.*<version project='firethorn'>\(.*\)<\/version>/\1/p
                    " pom.xml
                )
 
            pushd "target/firethorn-ogsadai-webapp-${projversion:?}/WEB-INF/etc/dai"

                jdbcconfig twomass  firethorn.twomass
                jdbcconfig ukidss   firethorn.ukidss
                jdbcconfig atlas    firethorn.atlas
                jdbcconfig wfau     firethorn.wfau
                jdbcconfig userdata firethorn.user

            popd
            
            export MAVEN_OPTS=-Xmx128m
            mvn tomcat7:run | tee /tmp/ogsadai-tomcat.log
         popd      
         
         
## create/edit integration/005/testing/config.py
        
        
cd ~/hg/integration/005/testing
python testing/test_firethorn.py
