#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2017, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#  
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

text
skipx
install

url  --mirrorlist "http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-$releasever&arch=$basearch"
repo --name fedora
repo --name updates
repo --name docker --install --baseurl "https://yum.dockerproject.org/repo/main/fedora/$releasever/"

zerombr
bootloader --location=mbr --boot-drive=vda

clearpart --all --initlabel
partition /boot   --type ext4  --size 256  --label boot
partition swap    --type swap  --size 1024 --label swap
partition btrfs.1 --type btrfs --grow      --label system

btrfs none --data single --label system btrfs.1
btrfs /    --subvol --name root system  

network  --bootproto=dhcp --device=ens3 --ipv6=auto --activate
network  --hostname=localhost.localdomain

firstboot --disable

selinux   --permissive
firewall  --enable --ssh

shutdown

lang en_GB.UTF-8
timezone Europe/London

#
# Roor user account 
rootpw --iscrypted $6$oh6Aic$Ep47UfaFUAy785YJs9tireb7p4BrWxPi4MGfDWdt6XxIpE6evRKzOz7VdQGSm9kfR6IARQNh6xaab1OeVLIfR0

sshkey --username root "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDCRRTQ9UK4kDGdBQPHRqe5p3jiADCxtiFschsXsoaIa5QNMnYKSCbA4t98vKrFAaB+oiBdjCE4uHh0Y3gpxKaqQ/Io39hXXNn89IZctbyvf94lWhFUWW48svLj3myqqTIbyc/kOckqBOC/hJW0xPGgoAOEjonnfJGJy5M+wqC/1y5S2/12Q+f1OYBAV9gIhJRRF7+hVrehhY8XmmSYkdotx1gWfA9uSjEqW4QFf00p/ZKJy7110Mxb6YIc3io5YPkB657wEn6ieZIYBsO9Vnq4k8XbJSDe+r1s+2h2yUJDYCqhrDakJjAx39aZITB0QmDN9nOMCj/DtrD8rMEAsdCz4Ws7wLxK0sie0/GGVRHxl/TzXnludo3YqbQumnHsm4LWo4YG9q8BbdX59+wK1n/7+LrzKIWy3M8b+3wQfJ8DyydsIA/gfzUvHh6oez/nTm36zFBWS1Lq61KWkjlCAO13WbCY5hw3i192FsnsXsAqcF3pLYrON/NaUm+kJRJAJAgSa7pAcHtRNS1RSXxnOgTFGP4nOPbwbPmFJg9qqY8J2BAIr4CXFLmiVxb0J4KD4ixqaSVVtL0c8rXzjy5fRfmLoHe90YXwMdFrmK3kXtsASFD5WlF+AsjAZMbf2zWDpJk3nF6TFgpiNFxNkpDAN7KIjblWKkQefnPto27UB/7Rbw== dmr@roe.ac.uk"
sshkey --username root "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDdqcK5D91MTuwc51Bo+3hAfQYfYVimvKqBkN8lOM5tXp4QlpSgQtWwQucELuFyhDY58oiEveyQrIa0z8OREe5aHACpOiDYgnnvyZgO4rBo5jviIbjrlQ+W0kIkHn4ZzGio0zb0O1kyHecfnAB9ISJttMzRDyZl4glCpK6fJ9zx4Az+Jt2kIihX1BRTdgZxeua1hIQLiWydyFU4+k/V7k2nhuoQGFovGL4uGhzJioI9xROXo3QosEN3ZnmVcch/T9d+trzlzrpoLVNCXBXlfYv6f8hzxG45N4l68Mhm9LeJWum7jIHCtIdgsGW+BOOOgZahE6bPkGkoGkvoIAzczHIpgdsTRJgw23oeYp/U2fierL3C9vlr6FOLaxQS8Iw15VQyTNeGfvRgeT1UQsqwcwZ/HAE697gRFyWu/ikrTtpCFShyrmWaOPEA1I6/mAB1FB2BHEdjWgxDzQBKlF52iGRIFb+0qR9GGGFFNTdLINoYtahMjhra9F6NKf+RJWjZ4keiMV8mv4UGNhnG/7BECuUbkYaLmMxyDLdRCsSE93Wc/+B2F9cR5WLuPJaV9JnSB3XDVklrCR+XK8Kfmqh9zJXAi/AjRZIuDJOGKfj06sh1SNaZw6JNzp6flYSIjRgreT0TktsJT32JrjNc6IWsphNxAfOy3Gx8kxi9QFhd6zLVAw== stv@roe.ac.uk"
sshkey --username root "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAqLgL7ClCX68Yr0HzwK1ptdWTdbArkOFYgh3XAc2vNzaGAlsA5JzFnBkVO3V+P2xQzALAwKtb4wRtm/jFldykHpPF++QpfvEUKy3RsFBdc4ybgAV36XvRmCtRGujkwDpRXE3MklgcUcLprOQJhc7dYPeJWibTVNSrcUaFiu5GKK3YoTKcuS2cR7QUZuDFXdaryNEAoX9Sf0mGraBvgm10sD5oLZHb1Gogml+u7DKA5jIFRSn/DeoGbriwMCzncsEKxAK5CWTpz1lZmTbq+8aElxWrbhnGczWuaUfSjFalQUMyuwiFgw8+V0Hr18sXOrpZIXpI4FPhukTdI+Gb7mfVPQ== msh@roe.ac.uk"

#
# Stevedore user account.
user --name Stevedore --password NO-PASSWORD --iscrypted --shell bash --uid 1010 --gid 1010 --groups users,wheel,docker
sshkey --username Stevedore "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDCRRTQ9UK4kDGdBQPHRqe5p3jiADCxtiFschsXsoaIa5QNMnYKSCbA4t98vKrFAaB+oiBdjCE4uHh0Y3gpxKaqQ/Io39hXXNn89IZctbyvf94lWhFUWW48svLj3myqqTIbyc/kOckqBOC/hJW0xPGgoAOEjonnfJGJy5M+wqC/1y5S2/12Q+f1OYBAV9gIhJRRF7+hVrehhY8XmmSYkdotx1gWfA9uSjEqW4QFf00p/ZKJy7110Mxb6YIc3io5YPkB657wEn6ieZIYBsO9Vnq4k8XbJSDe+r1s+2h2yUJDYCqhrDakJjAx39aZITB0QmDN9nOMCj/DtrD8rMEAsdCz4Ws7wLxK0sie0/GGVRHxl/TzXnludo3YqbQumnHsm4LWo4YG9q8BbdX59+wK1n/7+LrzKIWy3M8b+3wQfJ8DyydsIA/gfzUvHh6oez/nTm36zFBWS1Lq61KWkjlCAO13WbCY5hw3i192FsnsXsAqcF3pLYrON/NaUm+kJRJAJAgSa7pAcHtRNS1RSXxnOgTFGP4nOPbwbPmFJg9qqY8J2BAIr4CXFLmiVxb0J4KD4ixqaSVVtL0c8rXzjy5fRfmLoHe90YXwMdFrmK3kXtsASFD5WlF+AsjAZMbf2zWDpJk3nF6TFgpiNFxNkpDAN7KIjblWKkQefnPto27UB/7Rbw== dmr@roe.ac.uk"

%packages

# Text editors
sed
vim
nano
gawk
grep

# Archive tools
tar
zip
gzip

# Data access
wget
curl

# System admin
sudo
htop
pwgen

# Network admin
iputils
net-tools
bind-utils

# Time source
ntp

# Entropy source
haveged

# Docker tools
#docker-engine
#docker-compose

# Required for selinux-dockersock 
checkpolicy
policycoreutils
policycoreutils-python
policycoreutils-python-utils

%end

%pre

#
# Disable password login.
# http://redmine.roe.ac.uk/issues/1010
sed -i '
    s/^\(PasswordAuthentication\).*$/\1 no/
    ' /etc/ssh/sshd_config 

#
# Add the GPG key for the Docker repo.
cat >> /etc/yum.repos.d/docker.repo << EOF
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF

%end

%post

#
# Install docker-engine
dnf install -y docker-engine

#
# Install the dockersock SELinux policy.
# https://github.com/dpw/selinux-dockersock
pushd $(mktemp -d)
  wget https://raw.githubusercontent.com/dpw/selinux-dockersock/master/dockersock.te
  checkmodule -M -m -o dockersock.mod dockersock.te
  semodule_package -m dockersock.mod -o dockersock.pp
  semodule -i dockersock.pp
popd

#
# Install docker-compose from GitHub
curl -s -L https://github.com/docker/compose/releases/download/1.11.1/docker-compose-`uname -s`-`uname -m` > /usr/bin/docker-compose
chmod +x /usr/bin/docker-compose

#
# Configure NTP server.
cat >> /etc/ntp.conf << EOF
#
# EdLAN NTP server
# http://www.ed.ac.uk/information-services/computing/computing-infrastructure/network/ntp
server 129.215.205.191
EOF

#
# Enable our services.
systemctl enable ntpd
systemctl enable docker
systemctl enable haveged

%end

